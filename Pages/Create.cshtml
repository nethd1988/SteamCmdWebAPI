@page
@using SteamCmdWebAPI.Models
@using SteamCmdWebAPI.Services
@model SteamCmdWebAPI.Pages.CreateModel
@{
    ViewData["Title"] = "Tạo cấu hình mới - SteamAUTO";
}

@section Styles {
    <link rel="stylesheet" href="~/css/create-page.css" asp-append-version="true" />
}

<div class="page-header">
    <h1>Tạo Profile Game Mới</h1>
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger")" role="alert">
        <i class="bi bi-@(Model.IsSuccess ? "check-circle" : "exclamation-triangle") me-2"></i>
        @Model.StatusMessage
    </div>
}

<div class="mb-3">
    <button type="button" id="scanGamesBtn" class="btn btn-info" data-bs-toggle="tooltip" title="Quét các thư mục trên máy tính để tìm game đã cài đặt">
        <i class="bi bi-search"></i> Quét danh sách game
    </button>
</div>

<div class="row">
    <!-- Phần chọn profile từ server - Đưa lên trên -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-server me-2"></i>
                    Chọn profile từ Server
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="mb-4">
                    <label for="serverProfile" class="form-label mb-2">Profiles có sẵn trên server:</label>
                    <select id="serverProfile" class="form-select">
                        <option value="">-- Chọn profile từ server --</option>
                        @foreach (var profileName in Model.ServerProfiles)
                        {
                            <option value="@profileName" title="@profileName">@profileName</option>
                        }
                    </select>
                </div>
            </div>
        </div>
        <!-- Phần nhập thông tin cấu hình - Bên dưới -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin cấu hình mới</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="SaveProfile">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="Profile_Name" class="form-label">Tên Profile</label>
                        <input type="text" class="form-control" id="Profile_Name" asp-for="Profile.Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="Profile_AppID" class="form-label">App ID</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="Profile_AppID" asp-for="Profile.AppID" required>
                            <a href="https://steamdb.info/" target="_blank" class="btn btn-outline-secondary" title="Tìm App ID trên SteamDB">
                                <i class="bi bi-search"></i> SteamDB
                            </a>
                        </div>
                        <small class="text-muted">Nhập ID của game trên Steam. Ví dụ: 730 cho CS:GO</small>
                    </div>
                    <div class="mb-3">
                        <label for="Profile_InstallDirectory" class="form-label">Đường dẫn cài đặt</label>
                        <input type="text" class="form-control" id="Profile_InstallDirectory" asp-for="Profile.InstallDirectory" required>
                        <small class="text-muted">Thư mục cài đặt game</small>
                    </div>
                    <!-- Phần tài khoản/mật khẩu sẽ tự động ẩn khi chọn profile từ server -->
                    <div class="mb-3" id="accountSection">
                        <label class="form-label">Tài khoản Steam (tùy chọn)</label>
                        <div class="account-input-group mb-2">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="UseSteamAccounts" name="UseSteamAccounts" asp-for="UseSteamAccounts">
                                <label class="form-check-label" for="UseSteamAccounts">
                                    <strong>Sử dụng tài khoản từ SteamAccounts</strong>
                                </label>
                                <span class="text-muted ms-2">(Khuyến nghị - Tự động sử dụng tài khoản phù hợp với game)</span>
                            </div>
                        </div>
                        <div id="steamAccountsMessage" class="alert alert-success mb-2" style="display: none;">
                            <i class="bi bi-info-circle"></i> Hệ thống sẽ tự động sử dụng tài khoản phù hợp cho AppID này từ trang SteamAccounts.
                        </div>
                        <div id="manualAccountInputs">
                            <div class="mb-2">
                                <label asp-for="Username" class="form-label">Tên đăng nhập</label>
                                <input asp-for="Username" class="form-control" placeholder="Tên đăng nhập Steam" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="Password" class="form-label">Mật khẩu</label>
                                <input asp-for="Password" type="password" class="form-control" placeholder="Mật khẩu Steam" />
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="Profile_ValidateFiles" asp-for="Profile.ValidateFiles">
                                <label class="form-check-label" for="Profile_ValidateFiles">Kiểm tra và sửa chữa file</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="Profile_AutoRun" asp-for="Profile.AutoRun">
                                <label class="form-check-label" for="Profile_AutoRun">Tự động chạy khi khởi động</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="Profile_Arguments" class="form-label">Tham số bổ sung (tùy chọn)</label>
                        <input type="text" class="form-control" id="Profile_Arguments" asp-for="Profile.Arguments">
                        <small class="text-muted">Các tham số tùy chọn cho SteamCMD</small>
                    </div>
                    <input type="hidden" id="ServerProfileJson" name="ServerProfileJson" value="" />
                    <div class="d-flex">
                        <button type="submit" class="btn btn-primary me-2">Lưu cấu hình</button>
                        <a asp-page="/Index" class="btn btn-secondary">Hủy</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Phần hướng dẫn - Bên phải -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-gradient-success text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Hướng dẫn
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="guide-section mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-1-circle me-2 text-primary"></i>
                        Cách tạo profile mới
                    </h6>
                    <p class="text-muted">Nhập thông tin cần thiết cho profile game:</p>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>Tên Profile:</strong> Tên để nhận diện profile
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>App ID:</strong> ID của game trên Steam
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>Đường dẫn cài đặt:</strong> Thư mục cài đặt game
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>Tham số bổ sung:</strong> Các tham số tùy chọn
                        </li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-2-circle me-2 text-primary"></i>
                        Tài khoản Steam
                    </h6>
                    <p class="text-muted">Nhập thông tin tài khoản Steam để tải game (nếu game yêu cầu đăng nhập):</p>
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                        <div>
                            Bạn cũng có thể sử dụng nút "Quét danh sách game" để tự động tìm kiếm các game đã cài đặt trên máy.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chọn game -->
<div id="gamesModal" class="custom-modal">
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <!-- Header -->
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">
                    <i class="bi bi-controller"></i>
                    Chọn game để tạo Profile
                    <span class="game-count" id="gameCount">0 game</span>
                </h5>
                <button type="button" class="custom-close-btn" id="closeGamesModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="custom-modal-body">
                <!-- Thông báo -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <span>Nhấp vào game để điền thông tin vào form.</span>
                </div>

                <!-- Thanh tìm kiếm -->
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" id="gameSearchInput" placeholder="Tìm kiếm game...">
                </div>

                <!-- Thông báo số lượng game tìm thấy -->
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <span id="searchResultText">Đã tìm thấy 0 game đã cài đặt trên máy tính.</span>
                </div>

                <!-- Danh sách game -->
                <div class="games-list" id="gamesList">
                    <!-- Nội dung sẽ được thêm vào bằng JavaScript -->
                </div>
            </div>

            <!-- Footer -->
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-primary" id="importAllGamesBtn">
                    <i class="bi bi-download me-1"></i> Nhập tất cả game
                </button>
                <button type="button" class="btn btn-secondary" id="cancelGamesModal">
                    <i class="bi bi-x-circle me-1"></i> Đóng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị trạng thái đang quét -->
<div id="scanningModal" class="custom-modal">
    <div class="custom-modal-dialog custom-modal-sm">
        <div class="custom-modal-content">
            <div class="custom-modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Đang quét các thư mục trên máy tính...</h5>
                <p class="text-muted">Quá trình này có thể mất vài phút. Vui lòng đợi.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo lỗi -->
<div id="errorModal" class="custom-modal">
    <div class="custom-modal-dialog custom-modal-sm">
        <div class="custom-modal-content">
            <div class="custom-modal-header bg-danger">
                <h5 class="custom-modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Thông báo
                </h5>
                <button type="button" class="custom-close-btn" id="closeErrorModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="custom-modal-body text-center p-4">
                <p id="errorMessage">Đã xảy ra lỗi. Vui lòng thử lại.</p>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" id="closeErrorBtn">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div id="steamAccountsHelpModal" class="custom-modal">
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header bg-primary">
                <h5 class="custom-modal-title">
                    <i class="bi bi-question-circle-fill me-2"></i>
                    Hướng dẫn sử dụng tài khoản từ SteamAccounts
                </h5>
                <button type="button" class="custom-close-btn" id="closeHelpModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="custom-modal-body p-4">
                <div class="guide-section mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-1-circle me-2 text-primary"></i>
                        Tính năng tự động chọn tài khoản
                    </h6>
                    <p>Khi bạn sử dụng tính năng <strong>"Sử dụng tài khoản từ SteamAccounts"</strong>, hệ thống sẽ tự động:</p>
                    <ul class="mb-4">
                        <li class="mb-2">Kiểm tra AppID của game bạn đang tạo profile.</li>
                        <li class="mb-2">Tìm kiếm trong danh sách tài khoản đã lưu trên trang SteamAccounts.</li>
                        <li class="mb-2">Chọn tài khoản phù hợp cho AppID đó (một tài khoản có thể được cấu hình cho nhiều game).</li>
                        <li class="mb-2">Sử dụng tài khoản này khi vận hành game mà không cần nhập lại thông tin đăng nhập.</li>
                    </ul>
                    
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-2-circle me-2 text-primary"></i>
                        Cách thiết lập
                    </h6>
                    <ol class="mb-4">
                        <li class="mb-2">Truy cập trang <strong>SteamAccounts</strong> từ menu chính.</li>
                        <li class="mb-2">Thêm tài khoản Steam của bạn với thông tin đăng nhập.</li>
                        <li class="mb-2">Nhập <strong>AppID</strong> của các game trong mục "App IDs" (cách nhau bởi dấu phẩy, ví dụ: 570,730,440).</li>
                        <li class="mb-2">Hệ thống sẽ tự động xác định tên game tương ứng với các AppID.</li>
                        <li class="mb-2">Lưu lại cấu hình tài khoản.</li>
                    </ol>
                    
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-3-circle me-2 text-primary"></i>
                        Lợi ích khi sử dụng
                    </h6>
                    <ul class="mb-4">
                        <li class="mb-2">Một tài khoản có thể được sử dụng cho nhiều game khác nhau.</li>
                        <li class="mb-2">Tự động chọn tài khoản phù hợp mỗi khi bạn tạo profile mới.</li>
                        <li class="mb-2">Giảm thiểu việc phải nhập lại thông tin đăng nhập nhiều lần.</li>
                        <li class="mb-2">Bảo mật thông tin đăng nhập của bạn (mật khẩu được mã hóa trước khi lưu).</li>
                    </ul>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        <strong>Mẹo:</strong> Nếu bạn có nhiều tài khoản cho cùng một game, hệ thống sẽ sử dụng tài khoản đầu tiên tìm thấy. Bạn cũng có thể tạo tài khoản "Default" hoặc "Auto" để sử dụng cho tất cả các game mới thêm vào.
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-primary" id="closeHelpBtn">Đã hiểu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Select2 CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const serverProfileSelect = document.getElementById('serverProfile');
            const accountSection = document.getElementById('accountSection');
            const useSteamAccountsCheck = document.getElementById('UseSteamAccounts');
            const steamAccountsMessage = document.getElementById('steamAccountsMessage');
            const manualAccountInputs = document.getElementById('manualAccountInputs');
            const nameInput = document.getElementById('Profile_Name');
            const appIdInput = document.getElementById('Profile_AppID');
            const installDirInput = document.getElementById('Profile_InstallDirectory');
            const serverProfileJsonInput = document.getElementById('ServerProfileJson');
            
            // Thêm tooltip cho các nút trên trang
            var tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            if (tooltipTriggerList.length > 0) {
                var tooltipList = Array.from(tooltipTriggerList).map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            // Hiển thị modal thông báo lỗi tùy chỉnh
            function showErrorModal(message) {
                document.getElementById('errorMessage').textContent = message;
                showModal('errorModal');
            }
            
            // Xử lý nút đóng modal thông báo lỗi
            document.getElementById('closeErrorModal').addEventListener('click', function() {
                hideModal('errorModal');
            });
            
            document.getElementById('closeErrorBtn').addEventListener('click', function() {
                hideModal('errorModal');
            });
            
            // Kiểm tra trùng lặp AppID khi nhập
            $('#Profile_AppID').on('blur', function() {
                var appId = $(this).val().trim();
                if (!appId) return;
                
                // Gọi API để kiểm tra AppID đã tồn tại chưa
                $.ajax({
                    url: '?handler=CheckAppIdExists',
                    type: 'GET',
                    data: { appId: appId },
                    success: function(response) {
                        if (response && response.exists) {
                            // Hiển thị cảnh báo nếu AppID đã tồn tại
                            showErrorModal(`AppID ${appId} đã tồn tại trong profile '${response.profileName}'. Không thể tạo profile trùng lặp.`);
                            $('#Profile_AppID').addClass('is-invalid');
                            $('<div class="invalid-feedback">AppID này đã tồn tại trong hệ thống.</div>').insertAfter('#Profile_AppID');
                        } else {
                            // Nếu không trùng lặp, xóa lớp is-invalid
                            $('#Profile_AppID').removeClass('is-invalid');
                            $('#Profile_AppID').next('.invalid-feedback').remove();
                        }
                    }
                });
                
                // Xử lý khi nhập AppID để tự động lấy tên game
                var appId = $(this).val().trim();
                if (!appId) return;
                
                // Nếu tên profile chưa được nhập hoặc trùng với AppID cũ, cập nhật lại
                var currentName = $('#Profile_Name').val().trim();
                if (!currentName || currentName === appId) {
                    // Gọi API từ server để lấy tên game
                    $.ajax({
                        url: '/api/SteamApps/name/' + appId,
                        type: 'GET',
                        success: function(response) {
                            if (response && response.name) {
                                $('#Profile_Name').val(response.name);
                            }
                        }
                    });
                }
            });
            
            // Khi chọn/bỏ chọn UseSteamAccounts
            $('#UseSteamAccounts').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#steamAccountsMessage').show();
                    $('#manualAccountInputs').hide();
                } else {
                    $('#steamAccountsMessage').hide();
                    $('#manualAccountInputs').show();
                }
            });
            
            // Khởi tạo
            if ($('#UseSteamAccounts').is(':checked')) {
                $('#steamAccountsMessage').show();
                $('#manualAccountInputs').hide();
            } else {
                $('#steamAccountsMessage').hide();
                $('#manualAccountInputs').show();
            }

            // Initialize Select2 for server profile dropdown with cấu hình nâng cao
                    // Cấu hình nâng cao cho Select2
        $('#serverProfile').select2({
            width: '100%',
            dropdownCssClass: 'server-profile-dropdown',
            placeholder: '-- Chọn profile từ server --',
            allowClear: true,
            templateResult: formatProfileOption,
            escapeMarkup: function(markup) {
                return markup; // Cho phép HTML trong options
            },
            dropdownAutoWidth: true
        });

        // Function to format dropdown options - xử lý tên dài
        function formatProfileOption(option) {
            if (!option.id) {
                return option.text; // Skip placeholder
            }

            // Create a container for the option with wrapped text
            var $container = $(
                '<div class="select2-option-container" title="' + option.text + '">' +
                '<span class="select2-option-text">' + option.text + '</span>' +
                '</div>'
            );

            return $container;
        }

        // Xử lý khi select2 được khởi tạo xong
        $('#serverProfile').on('select2:open', function() {
            // Đảm bảo dropdown được hiển thị đúng kích thước
            $('.select2-results__options').css('max-width', '500px');
            $('.select2-results__options').css('word-break', 'break-word');
        });

        // Modal thông báo lỗi tùy chỉnh
        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            showModal('errorModal');
        }

        // Xử lý khi chọn profile từ server
        $('#serverProfile').on('select2:select', function(e) {
            var selectedProfile = $(this).val();
            if (!selectedProfile) {
                // Nếu không chọn profile nào, hiển thị phần account section
                $('#accountSection').show();
                // Reset ServerProfileJson để tránh lỗi
                $("#ServerProfileJson").val("");
                return;
            }

            // Hiển thị modal đang quét
            showModal('scanningModal');

            // Gọi AJAX lấy profile từ server
            $.ajax({
                url: "?handler=ProfileDetails",
                type: "GET",
                cache: false,
                data: { profileName: selectedProfile },
                success: function(response) {
                    // Đóng modal đang quét
                    hideModal('scanningModal');

                    if (response.success && response.profile) {
                        // Lưu thông tin profile từ server vào hidden field
                        $("#ServerProfileJson").val(JSON.stringify(response.profile));

                        // Điền thông tin profile - đảm bảo xử lý tên dài
                        $("#Profile_Name").val(response.profile.name.trim());
                        $("#Profile_AppID").val(response.profile.appID);

                        // Đảm bảo ẩn phần nhập tài khoản khi chọn profile từ server
                        $('#accountSection').hide();

                        // Focus vào trường tiếp theo để người dùng tiếp tục nhập
                        $("#Profile_InstallDirectory").focus();
                    } else {
                        // Hiển thị lỗi thân thiện
                        showErrorModal("Không thể lấy thông tin profile từ server.");
                        $('#accountSection').show();
                    }
                },
                error: function(error) {
                    // Đóng modal đang quét
                    hideModal('scanningModal');

                    console.error("Lỗi khi lấy profile từ server:", error);
                    showErrorModal("Đã xảy ra lỗi khi lấy thông tin profile từ server.");
                    $('#accountSection').show();
                }
            });
        });
            
            // Function to format dropdown options - cải tiến hiển thị profile dài
            function formatProfileOption(option) {
                if (!option.id) {
                    return option.text; // Skip placeholder
                }
                
                // Create a container for the option with wrapped text
                var $container = $(
                    '<div class="select2-option-container" title="' + option.text + '">' +
                    '<span class="select2-option-text">' + option.text + '</span>' +
                    '</div>'
                );
                
                return $container;
            }
            
            // Sync Select2 with original handlers
            $('#serverProfile').on('select2:select', function (e) {
                // Trigger the original change event
                $(this).trigger('change');
            });
            
            // Xử lý hiển thị/ẩn modals
            window.showModal = function(modalId) {
                console.log("Hiển thị modal:", modalId);
                const modal = document.getElementById(modalId);
                modal.style.display = 'flex';
                
                // Force reflow to ensure transition works
                modal.offsetHeight;
                
                modal.classList.add('show');
            }
            
            window.hideModal = function(modalId) {
                console.log("Ẩn modal:", modalId);
                const modal = document.getElementById(modalId);
                modal.classList.remove('show');
                
                // Wait for transition to complete before hiding completely
                setTimeout(() => {
                    if (!modal.classList.contains('show')) {
                        modal.style.display = 'none';
                    }
                }, 300);
            }
        });
    </script>
    
    <!-- Script xử lý quét và nhập games -->
    <script>
        $(document).ready(function () {
            // Biến lưu trữ danh sách games được tìm thấy
            let foundGames = [];
            
            // Xử lý các nút đóng modal
            document.getElementById('closeGamesModal').addEventListener('click', function() {
                hideModal('gamesModal');
            });
            
            document.getElementById('cancelGamesModal').addEventListener('click', function() {
                hideModal('gamesModal');
            });
            
            // Xử lý khi click nút quét games
            $('#scanGamesBtn').click(function (e) {
                e.preventDefault();
                console.log("Đã nhấn nút quét games");
                
                // Hiển thị modal đang quét
                showModal('scanningModal');
                
                // Gọi API scan games
                $.ajax({
                    url: '?handler=ScanGames',
                    type: 'GET',
                    success: function (response) {
                        // Đóng modal đang quét
                        hideModal('scanningModal');
                        
                        if (response.success && response.games && response.games.length > 0) {
                            foundGames = response.games;
                            console.log(`Tìm thấy ${foundGames.length} games`);
                            
                            // Đợi một chút trước khi hiển thị modal games
                            setTimeout(function() {
                                showGamesModal(foundGames);
                            }, 300);
                        } else {
                            showErrorModal(response.message || 'Không tìm thấy game nào hoặc tất cả game đã có profile.');
                        }
                    },
                    error: function (error) {
                        hideModal('scanningModal');
                        console.error('Lỗi khi quét games:', error);
                        showErrorModal('Đã xảy ra lỗi khi quét games. Vui lòng thử lại sau.');
                    }
                });
            });
            
            // Hiển thị modal danh sách games
            function showGamesModal(games) {
                console.log("Chuẩn bị hiển thị modal games");
                
                // Cập nhật số lượng game
                $('#gameCount').text(`${games.length} game`);
                
                // Cập nhật kết quả tìm kiếm
                $('#searchResultText').text(`Đã tìm thấy ${games.length} game đã cài đặt trên máy tính.`);
                
                // Cập nhật danh sách games
                const $gamesList = $('#gamesList');
                $gamesList.empty();
                
                // Thêm các game vào danh sách
                games.forEach(game => {
                    const $gameItem = $(`
                        <div class="game-item" data-app-id="${game.appId}" data-game-name="${game.gameName}" data-install-dir="${game.installDir}">
                            <div class="game-info">
                                <div class="game-title" title="${game.gameName}">${game.gameName}</div>
                                <div class="game-details">
                                    <span>AppID: ${game.appId}</span>
                                    <span title="${game.installDir}">${game.installDir.split('\\').pop()}</span>
                                </div>
                            </div>
                            <button class="btn-select select-game-btn">
                                <i class="bi bi-plus-circle"></i> Chọn
                            </button>
                        </div>
                    `);
                    
                    $gamesList.append($gameItem);
                });
                
                // Thiết lập sự kiện cho các nút trong danh sách games
                setupGamesClickEvents();
                
                // Hiển thị modal games
                showModal('gamesModal');
                console.log("Đã hiển thị modal games");
            }
            
            // Thiết lập sự kiện click cho các nút trong danh sách games
            function setupGamesClickEvents() {
                // Xử lý sự kiện click nút chọn game
                $('.select-game-btn').off('click').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const $gameItem = $(this).closest('.game-item');
                    const appId = $gameItem.data('app-id');
                    const gameName = $gameItem.data('game-name');
                    const installDir = $gameItem.data('install-dir');
                    
                    console.log("Đã chọn game:", gameName);
                    
                    // Điền thông tin vào form
                    $('#Profile_Name').val(gameName);
                    $('#Profile_AppID').val(appId);
                    $('#Profile_InstallDirectory').val(installDir);
                    
                    // Đóng modal
                    hideModal('gamesModal');
                });
                
                // Xử lý nút nhập tất cả game
                $('#importAllGamesBtn').off('click').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (confirm(`Bạn có chắc muốn nhập tất cả ${foundGames.length} game vào hệ thống không?`)) {
                        importAllGames(foundGames);
                    }
                });
                
                // Xử lý tìm kiếm game
                $('#gameSearchInput').off('input').on('input', function() {
                    const searchTerm = $(this).val().toLowerCase().trim();
                    filterGames(searchTerm);
                });
            }
            
            // Hàm lọc danh sách game theo từ khóa tìm kiếm
            function filterGames(searchTerm) {
                const $gameItems = $('.game-item');
                let visibleCount = 0;
                
                $gameItems.each(function() {
                    const $item = $(this);
                    const gameName = $item.data('game-name').toLowerCase();
                    const appId = $item.data('app-id').toString();
                    const installDir = $item.data('install-dir').toLowerCase();

                    if (searchTerm === '' ||
                        gameName.includes(searchTerm) ||
                        appId.includes(searchTerm) ||
                        installDir.includes(searchTerm)) {
                        $item.show();
                        visibleCount++;
                    } else {
                        $item.hide();
                    }
                });

                // Cập nhật thông báo kết quả tìm kiếm
                if (searchTerm === '') {
                    $('#searchResultText').text(`Đã tìm thấy ${foundGames.length} game đã cài đặt trên máy tính.`);
                } else {
                    $('#searchResultText').text(`Tìm thấy ${visibleCount} kết quả cho "${searchTerm}"`);
                }
            }

            // Hàm nhập tất cả games
            function importAllGames(games) {
                // Đóng modal games
                hideModal('gamesModal');

                // Đợi một chút trước khi hiển thị modal đang xử lý
                setTimeout(function() {
                    // Hiển thị modal đang xử lý
                    showModal('scanningModal');

                    // Chuẩn bị dữ liệu để gửi lên server
                    const gamesToImport = games.map(game => ({
                        AppId: game.appId,
                        Name: game.gameName,
                        InstallPath: game.installDir
                    }));

                    // Gọi API để nhập tất cả games
                    $.ajax({
                        url: '?handler=ImportAllGames',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(gamesToImport),
                        headers: {
                            RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            hideModal('scanningModal');

                            if (response.success) {
                                // Sử dụng modal thông báo tùy chỉnh thay vì alert
                                showSuccessModal(`Đã nhập thành công ${response.importedCount} game. ${response.message}`);

                                // Đợi một chút trước khi chuyển trang
                                setTimeout(function() {
                                    // Chuyển đến trang quản lý cập nhật
                                    window.location.href = '/UpdateManagement';
                                }, 1500);
                            } else {
                                showErrorModal('Lỗi khi nhập games: ' + response.message);
                            }
                        },
                        error: function(error) {
                            hideModal('scanningModal');
                            console.error('Lỗi khi nhập tất cả games:', error);
                            showErrorModal('Đã xảy ra lỗi khi nhập games. Vui lòng thử lại sau.');
                        }
                    });
                }, 300);
            }

            // Hàm hiển thị thông báo thành công
            function showSuccessModal(message) {
                // Thêm nội dung thông báo thành công
                $('#errorModal .custom-modal-header').removeClass('bg-danger').addClass('bg-success');
                $('#errorModal .custom-modal-title').html('<i class="bi bi-check-circle-fill me-2"></i> Thành công');
                $('#errorMessage').text(message);
                showModal('errorModal');
            }

            // Hàm hiển thị thông báo lỗi
            function showErrorModal(message) {
                // Đảm bảo modal có đúng style lỗi
                $('#errorModal .custom-modal-header').removeClass('bg-success').addClass('bg-danger');
                $('#errorModal .custom-modal-title').html('<i class="bi bi-exclamation-triangle-fill me-2"></i> Thông báo');
                $('#errorMessage').text(message);
                showModal('errorModal');
            }

            // Thêm nút và xử lý hiển thị modal hướng dẫn
            $('#steamAccountsMessage').append('<button id="showHelpModalBtn" class="btn btn-sm btn-link ms-2">Xem hướng dẫn chi tiết</button>');
            
            $('#showHelpModalBtn').click(function(e) {
                e.preventDefault();
                showModal('steamAccountsHelpModal');
            });
            
            $('#closeHelpModal, #closeHelpBtn').click(function() {
                hideModal('steamAccountsHelpModal');
            });
        });
    </script>
}