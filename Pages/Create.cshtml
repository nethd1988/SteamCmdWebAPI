@page
@using SteamCmdWebAPI.Models
@using SteamCmdWebAPI.Services
@model SteamCmdWebAPI.Pages.CreateModel
@{
    ViewData["Title"] = "Tạo cấu hình mới - SteamAUTO";
}

@section Styles {
    <link rel="stylesheet" href="~/css/create-page.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/profile-selection.css" asp-append-version="true" />
}

<div class="page-header">
    <h1>Tạo Profile Game Mới</h1>
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger")" role="alert">
        <i class="bi bi-@(Model.IsSuccess ? "check-circle" : "exclamation-triangle") me-2"></i>
        @Model.StatusMessage
    </div>
}

<div class="mb-3">
    <button type="button" id="scanGamesBtn" class="btn btn-info" data-bs-toggle="tooltip" title="Quét các thư mục trên máy tính để tìm game đã cài đặt">
        <i class="bi bi-search"></i> Quét danh sách game
    </button>
</div>

<div class="row">
    <!-- Phần chọn profile từ server - Đưa lên trên -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-server me-2"></i>
                    Chọn profile từ Server
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="profile-select-container">
                    <label class="profile-select-label mb-2">Profiles có sẵn trên server:</label>
                    <div class="profile-search">
                        <span class="profile-search-icon">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="profile-search-input" placeholder="Tìm kiếm profile...">
                    </div>
                    <select id="serverProfile" class="profile-select">
                        <option value="">-- Chọn profile từ server --</option>
                        @foreach (var profileName in Model.ServerProfiles)
                        {
                            <option value="@profileName" title="@profileName">@profileName</option>
                        }
                    </select>
                    
                    <!-- Thông tin profile khi được chọn - Ẩn đi vì không cần thiết -->
                    <div id="profileInfoCard" class="mt-3 d-none" style="display:none;">
                        <div class="card bg-light">
                            <div class="card-header bg-info text-white d-flex align-items-center">
                                <i class="bi bi-info-circle me-2"></i>
                                <span>Thông tin Profile</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Tên:</strong> <span id="profileNameDisplay"></span></p>
                                        <p class="mb-2"><strong>App ID:</strong> <span id="profileAppIdDisplay"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Thư mục:</strong> <span id="profileDirectoryDisplay"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Phần nhập thông tin cấu hình - Bên dưới -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin cấu hình mới</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="SaveProfile">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="Profile_Name" class="form-label">Tên Profile</label>
                        <input type="text" class="form-control" id="Profile_Name" asp-for="Profile.Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="Profile_AppID" class="form-label">App ID</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="Profile_AppID" asp-for="Profile.AppID" required>
                            <a href="https://steamdb.info/" target="_blank" class="btn btn-outline-secondary" title="Tìm App ID trên SteamDB">
                                <i class="bi bi-search"></i> SteamDB
                            </a>
                        </div>
                        <small class="text-muted">Nhập ID của game trên Steam. Ví dụ: 730 cho CS:GO</small>
                    </div>
                    <div class="mb-3">
                        <label for="Profile_InstallDirectory" class="form-label">Đường dẫn cài đặt</label>
                        <input type="text" class="form-control" id="Profile_InstallDirectory" asp-for="Profile.InstallDirectory" required>
                        <small class="text-muted">Thư mục cài đặt game</small>
                    </div>
                    <!-- Phần tài khoản/mật khẩu sẽ tự động ẩn khi chọn profile từ server -->
                    <div class="mb-3" id="accountSection">
                        <label class="form-label">Tài khoản Steam (tùy chọn)</label>
                        <div class="account-input-group mb-2">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="UseSteamAccounts" name="UseSteamAccounts" asp-for="UseSteamAccounts">
                                <label class="form-check-label" for="UseSteamAccounts">
                                    <strong>Sử dụng tài khoản từ SteamAccounts</strong>
                                </label>
                                <span class="text-muted ms-2">(Khuyến nghị - Tự động sử dụng tài khoản phù hợp với game)</span>
                            </div>
                        </div>
                        <div id="steamAccountsMessage" class="alert alert-success mb-2" style="display: none;">
                            <i class="bi bi-info-circle"></i> Hệ thống sẽ tự động sử dụng tài khoản phù hợp cho AppID này từ trang SteamAccounts.
                        </div>
                        <div id="manualAccountInputs">
                            <div class="mb-2">
                                <label asp-for="Username" class="form-label">Tên đăng nhập</label>
                                <input asp-for="Username" class="form-control" placeholder="Tên đăng nhập Steam" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="Password" class="form-label">Mật khẩu</label>
                                <input asp-for="Password" type="password" class="form-control" placeholder="Mật khẩu Steam" />
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="Profile_ValidateFiles" asp-for="Profile.ValidateFiles">
                                <label class="form-check-label" for="Profile_ValidateFiles">Kiểm tra và sửa chữa file</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="Profile_AutoRun" asp-for="Profile.AutoRun">
                                <label class="form-check-label" for="Profile_AutoRun">Tự động chạy khi khởi động</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="Profile_Arguments" class="form-label">Tham số bổ sung (tùy chọn)</label>
                        <input type="text" class="form-control" id="Profile_Arguments" asp-for="Profile.Arguments">
                        <small class="text-muted">Các tham số tùy chọn cho SteamCMD</small>
                    </div>
                    <input type="hidden" id="ServerProfileJson" name="ServerProfileJson" value="" />
                    <div class="d-flex">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-save me-1"></i>
                            Lưu cấu hình
                        </button>
                        <a asp-page="/Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>
                            Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Phần hướng dẫn - Bên phải -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-gradient-success text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Hướng dẫn
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="guide-section mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-1-circle me-2 text-primary"></i>
                        Cách tạo profile mới
                    </h6>
                    <p class="text-muted">Nhập thông tin cần thiết cho profile game:</p>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>Tên Profile:</strong> Tên để nhận diện profile
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>App ID:</strong> ID của game trên Steam
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>Đường dẫn cài đặt:</strong> Thư mục cài đặt game
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>Tham số bổ sung:</strong> Các tham số tùy chọn
                        </li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-2-circle me-2 text-primary"></i>
                        Tài khoản Steam
                    </h6>
                    <p class="text-muted">Nhập thông tin tài khoản Steam để tải game (nếu game yêu cầu đăng nhập):</p>
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                        <div>
                            Bạn cũng có thể sử dụng nút "Quét danh sách game" để tự động tìm kiếm các game đã cài đặt trên máy.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chọn game -->
<div id="gamesModal" class="custom-modal">
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <!-- Header -->
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">
                    <i class="bi bi-controller"></i>
                    Chọn game để tạo Profile
                    <span class="game-count" id="gameCount">0 game</span>
                </h5>
                <button type="button" class="custom-close-btn" id="closeGamesModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="custom-modal-body">
                <!-- Thông báo -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <span>Nhấp vào game để điền thông tin vào form.</span>
                </div>

                <!-- Thanh tìm kiếm -->
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" id="gameSearchInput" placeholder="Tìm kiếm game...">
                </div>

                <!-- Thông báo số lượng game tìm thấy -->
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <span id="searchResultText">Đã tìm thấy 0 game đã cài đặt trên máy tính.</span>
                </div>

                <!-- Danh sách game -->
                <div class="games-list" id="gamesList">
                    <!-- Nội dung sẽ được thêm vào bằng JavaScript -->
                </div>
            </div>

            <!-- Footer -->
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-primary" id="importAllGamesBtn">
                    <i class="bi bi-download me-1"></i> Nhập tất cả game
                </button>
                <button type="button" class="btn btn-secondary" id="cancelGamesModal">
                    <i class="bi bi-x-circle me-1"></i> Đóng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal hiển thị trạng thái đang quét -->
<div id="scanningModal" class="custom-modal">
    <div class="custom-modal-dialog custom-modal-sm">
        <div class="custom-modal-content">
            <div class="custom-modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Đang quét các thư mục trên máy tính...</h5>
                <p class="text-muted">Quá trình này có thể mất vài phút. Vui lòng đợi.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo lỗi -->
<div id="errorModal" class="custom-modal">
    <div class="custom-modal-dialog custom-modal-sm">
        <div class="custom-modal-content">
            <div class="custom-modal-header bg-danger">
                <h5 class="custom-modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Thông báo
                </h5>
                <button type="button" class="custom-close-btn" id="closeErrorModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="custom-modal-body text-center p-4">
                <p id="errorMessage">Đã xảy ra lỗi. Vui lòng thử lại.</p>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" id="closeErrorBtn">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div id="steamAccountsHelpModal" class="custom-modal">
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header bg-primary">
                <h5 class="custom-modal-title">
                    <i class="bi bi-question-circle-fill me-2"></i>
                    Hướng dẫn sử dụng tài khoản từ SteamAccounts
                </h5>
                <button type="button" class="custom-close-btn" id="closeHelpModal">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="custom-modal-body p-4">
                <div class="guide-section mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-1-circle me-2 text-primary"></i>
                        Tính năng tự động chọn tài khoản
                    </h6>
                    <p>Khi bạn sử dụng tính năng <strong>"Sử dụng tài khoản từ SteamAccounts"</strong>, hệ thống sẽ tự động:</p>
                    <ul class="mb-4">
                        <li class="mb-2">Kiểm tra AppID của game bạn đang tạo profile.</li>
                        <li class="mb-2">Tìm kiếm trong danh sách tài khoản đã lưu trên trang SteamAccounts.</li>
                        <li class="mb-2">Chọn tài khoản phù hợp cho AppID đó (một tài khoản có thể được cấu hình cho nhiều game).</li>
                        <li class="mb-2">Sử dụng tài khoản này khi vận hành game mà không cần nhập lại thông tin đăng nhập.</li>
                    </ul>
                    
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-2-circle me-2 text-primary"></i>
                        Cách thiết lập
                    </h6>
                    <ol class="mb-4">
                        <li class="mb-2">Truy cập trang <strong>SteamAccounts</strong> từ menu chính.</li>
                        <li class="mb-2">Thêm tài khoản Steam của bạn với thông tin đăng nhập.</li>
                        <li class="mb-2">Nhập <strong>AppID</strong> của các game trong mục "App IDs" (cách nhau bởi dấu phẩy, ví dụ: 570,730,440).</li>
                        <li class="mb-2">Hệ thống sẽ tự động xác định tên game tương ứng với các AppID.</li>
                        <li class="mb-2">Lưu lại cấu hình tài khoản.</li>
                    </ol>
                    
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-3-circle me-2 text-primary"></i>
                        Lợi ích khi sử dụng
                    </h6>
                    <ul class="mb-4">
                        <li class="mb-2">Một tài khoản có thể được sử dụng cho nhiều game khác nhau.</li>
                        <li class="mb-2">Tự động chọn tài khoản phù hợp mỗi khi bạn tạo profile mới.</li>
                        <li class="mb-2">Giảm thiểu việc phải nhập lại thông tin đăng nhập nhiều lần.</li>
                        <li class="mb-2">Bảo mật thông tin đăng nhập của bạn (mật khẩu được mã hóa trước khi lưu).</li>
                    </ul>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        <strong>Mẹo:</strong> Nếu bạn có nhiều tài khoản cho cùng một game, hệ thống sẽ sử dụng tài khoản đầu tiên tìm thấy. Bạn cũng có thể tạo tài khoản "Default" hoặc "Auto" để sử dụng cho tất cả các game mới thêm vào.
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-primary" id="closeHelpBtn">Đã hiểu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/profile-selection.js" asp-append-version="true"></script>
    <script>
        $(document).ready(function() {
            // Show profile info card when a profile is selected
            $('#serverProfile').on('change', function() {
                var selectedProfile = $(this).val();
                if (!selectedProfile) {
                    // Nếu không chọn profile nào, hiển thị phần account section
                    $('#accountSection').show();
                    // Reset ServerProfileJson để tránh lỗi
                    $("#ServerProfileJson").val("");
                    // Ẩn thẻ thông tin profile
                    $('#profileInfoCard').addClass('d-none');
                    return;
                }

                // Hiển thị modal đang quét
                showModal('scanningModal');

                // Gọi AJAX lấy profile từ server
                $.ajax({
                    url: "?handler=ProfileDetails",
                    type: "GET",
                    cache: false,
                    data: { profileName: selectedProfile },
                    success: function(response) {
                        // Đóng modal đang quét
                        hideModal('scanningModal');

                        if (response.success && response.profile) {
                            // Lưu thông tin profile từ server vào hidden field
                            $("#ServerProfileJson").val(JSON.stringify(response.profile));

                            // Điền thông tin profile - đảm bảo xử lý tên dài
                            $("#Profile_Name").val(response.profile.name.trim());
                            $("#Profile_AppID").val(response.profile.appID);
                            // Điền đường dẫn cài đặt nếu có
                            if (response.profile.installDirectory) {
                                $("#Profile_InstallDirectory").val(response.profile.installDirectory);
                            }

                            // Đảm bảo ẩn phần nhập tài khoản khi chọn profile từ server
                            $('#accountSection').hide();

                            // Không hiển thị thẻ thông tin profile
                            $('#profileInfoCard').addClass('d-none');

                            // Focus vào trường tiếp theo để người dùng tiếp tục nhập
                            $("#Profile_InstallDirectory").focus();
                        } else {
                            // Hiển thị lỗi thân thiện
                            showErrorModal("Không thể lấy thông tin profile từ server.");
                            $('#accountSection').show();
                        }
                    },
                    error: function() {
                        hideModal('scanningModal');
                        showErrorModal("Lỗi kết nối đến server.");
                        $('#accountSection').show();
                    }
                });
            });

            // Xử lý quét game khi nhấn nút Scan
            $('#scanGamesBtn').on('click', function() {
                // Hiển thị modal đang quét
                showModal('scanningModal');
                
                // Gọi API quét game
                $.ajax({
                    url: "?handler=ScanGames",
                    type: "GET",
                    cache: false,
                    success: function(response) {
                        // Đóng modal đang quét
                        hideModal('scanningModal');
                        
                        if (response.success) {
                            // Cập nhật số lượng game tìm thấy
                            const games = response.games || [];
                            $('#gameCount').text(games.length + ' game');
                            $('#searchResultText').text('Đã tìm thấy ' + games.length + ' game đã cài đặt trên máy tính.');
                            
                            // Xóa danh sách game cũ
                            const gamesList = $('#gamesList');
                            gamesList.empty();
                            
                            // Thêm game vào danh sách
                            games.forEach(function(game) {
                                const gameItem = $('<div class="game-item">')
                                    .attr('data-appid', game.appId)
                                    .attr('data-name', game.gameName)
                                    .attr('data-path', game.installDir);
                                
                                const gameIcon = $('<div class="game-icon"><i class="bi bi-controller"></i></div>');
                                
                                const gameInfo = $('<div class="game-info">');
                                const gameName = $('<h4 class="game-title">').text(game.gameName);
                                const gameAppId = $('<div class="game-details">').html('<span class="label-id">AppID:</span> ' + game.appId);
                                const gamePath = $('<div class="game-path">').text(game.installDir);
                                
                                gameInfo.append(gameName, gameAppId, gamePath);
                                gameItem.append(gameIcon, gameInfo);
                                gamesList.append(gameItem);
                            });
                            
                            // Thêm xử lý khi click vào game
                            $('.game-item').on('click', function() {
                                const appId = $(this).data('appid');
                                const name = $(this).data('name');
                                const path = $(this).data('path');
                                
                                // Điền thông tin vào form
                                $('#Profile_Name').val(name);
                                $('#Profile_AppID').val(appId);
                                $('#Profile_InstallDirectory').val(path);
                                
                                // Ẩn modal game
                                hideModal('gamesModal');
                            });
                            
                            // Hiển thị modal danh sách game
                            showModal('gamesModal');
                            
                            // Xử lý tìm kiếm game
                            $('#gameSearchInput').on('keyup', function() {
                                const searchText = $(this).val().toLowerCase();
                                $('.game-item').each(function() {
                                    const gameTitle = $(this).find('.game-title').text().toLowerCase();
                                    const gameId = $(this).data('appid').toString();
                                    
                                    if (gameTitle.includes(searchText) || gameId.includes(searchText)) {
                                        $(this).show();
                                    } else {
                                        $(this).hide();
                                    }
                                });
                            });
                        } else {
                            // Hiển thị thông báo lỗi
                            $('#errorMessage').text(response.message || 'Không tìm thấy game nào hoặc tất cả game đã có profile');
                            showModal('errorModal');
                        }
                    },
                    error: function(xhr, status, error) {
                        // Đóng modal đang quét
                        hideModal('scanningModal');
                        
                        // Hiển thị thông báo lỗi
                        $('#errorMessage').text('Đã xảy ra lỗi khi quét game: ' + (error || 'Không thể kết nối đến server'));
                        showModal('errorModal');
                    }
                });
            });
            
            // Xử lý nút đóng modal game
            $('#closeGamesModal, #cancelGamesModal').on('click', function() {
                hideModal('gamesModal');
            });
            
            // Xử lý nút đóng modal lỗi
            $('#closeErrorModal, #closeErrorBtn').on('click', function() {
                hideModal('errorModal');
            });
            
            // Xử lý nút nhập tất cả game
            $('#importAllGamesBtn').on('click', function() {
                // Collect all game data
                const games = [];
                $('.game-item').each(function() {
                    games.push({
                        appId: $(this).data('appid'),
                        name: $(this).data('name'),
                        installPath: $(this).data('path')
                    });
                });
                
                // Hiển thị modal đang quét
                hideModal('gamesModal');
                showModal('scanningModal');
                
                // Gọi API nhập tất cả game
                $.ajax({
                    url: "?handler=ImportAllGames",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(games),
                    headers: {
                        "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        hideModal('scanningModal');
                        
                        if (response.success) {
                            // Chuyển về trang UpdateManagement nếu import thành công
                            window.location.href = response.redirectUrl || '/UpdateManagement';
                        } else {
                            // Hiển thị thông báo lỗi
                            $('#errorMessage').text(response.message || 'Không thể nhập game');
                            showModal('errorModal');
                        }
                    },
                    error: function() {
                        hideModal('scanningModal');
                        $('#errorMessage').text('Đã xảy ra lỗi khi nhập game');
                        showModal('errorModal');
                    }
                });
            });

            // Hàm hiển thị modal
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                // Ensure the modal is properly centered by setting display flex first
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
            }
            
            // Hàm ẩn modal
            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
            
            // Hàm hiển thị thông báo lỗi
            function showErrorModal(message) {
                $('#errorMessage').text(message);
                showModal('errorModal');
            }
        });
    </script>
}