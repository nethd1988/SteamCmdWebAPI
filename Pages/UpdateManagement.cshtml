@page
@model SteamCmdWebAPI.Pages.UpdateManagementModel
@{
    ViewData["Title"] = "Quản lý cập nhật";
    ViewData["ActivePage"] = "UpdateManagement";
}

<div class="page-header">
    <h1>Quản lý cập nhật game</h1>
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger")">
        <i class="bi bi-@(Model.IsSuccess ? "check-circle" : "exclamation-triangle") me-2"></i>
        @Model.StatusMessage
    </div>
}

<form method="post" id="antiForgeryForm">
    @Html.AntiForgeryToken()
</form>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Thao tác thủ công</h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <p>Sử dụng các nút dưới đây để kiểm tra cập nhật ngay lập tức hoặc xóa cache thông tin cập nhật.</p>
            <div class="d-flex gap-2 flex-wrap">
                <button id="checkUpdatesBtn" class="btn btn-primary">
                    <i class="bi bi-cloud-download me-1"></i> Kiểm tra cập nhật ngay
                </button>
                <button id="clearCacheBtn" class="btn btn-secondary">
                    <i class="bi bi-trash me-1"></i> Xóa cache cập nhật
                </button>
            </div>
        </div>
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Lưu ý:</strong> "Kiểm tra cập nhật ngay" sẽ kiểm tra tất cả profile và thêm các game có cập nhật mới vào hàng đợi.
            "Xóa cache cập nhật" sẽ buộc hệ thống tải lại thông tin từ Steam API ở lần kiểm tra tiếp theo.
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Cài đặt kiểm tra cập nhật tự động</h5>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="SaveUpdateCheckSettings">
            @Html.AntiForgeryToken()
            <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="updateCheckEnabled" asp-for="UpdateCheckEnabled" />
                <label class="form-check-label" for="updateCheckEnabled">Kích hoạt kiểm tra cập nhật tự động</label>
            </div>
            <div class="mb-3">
                <label for="updateCheckIntervalMinutes" class="form-label">Khoảng thời gian kiểm tra (phút)</label>
                <input type="number" class="form-control" id="updateCheckIntervalMinutes" asp-for="UpdateCheckIntervalMinutes" min="10" max="1440" step="10" />
                <small class="form-text text-muted">Hệ thống sẽ kiểm tra cập nhật mới sau mỗi khoảng thời gian này (tối thiểu 10 phút, tối đa 1440 phút).</small>
            </div>
            <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="autoUpdateProfiles" asp-for="AutoUpdateProfiles" />
                <label class="form-check-label" for="autoUpdateProfiles">Tự động cập nhật profile khi có cập nhật mới</label>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="bi bi-save me-1"></i>
                Lưu cài đặt kiểm tra cập nhật
            </button>
        </form>
    </div>
</div>

<!-- Phần chọn profile sẽ được hiển thị tại đây khi nhấn nút chọn profile -->
<div id="profileSelectionContainer" class="card mb-4" style="display: none;">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Chọn Profile cho Game: <span id="selectedGameName"></span></h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <h6>Thông tin hiện tại:</h6>
            <div class="d-flex flex-wrap">
                <div class="me-3 mb-2"><strong>AppID:</strong> <span id="currentAppId"></span></div>
                <div class="me-3 mb-2"><strong>Profile:</strong> <span id="currentProfileName"></span></div>
            </div>
        </div>

        <h6>Chọn profile mới:</h6>
        <div class="table-responsive">
            <table class="table table-hover table-striped table-bordered" id="profilesTable">
                <thead class="table-light">
                    <tr>
                        <th width="5%">ID</th>
                        <th width="20%">Tên Profile</th>
                        <th width="25%">Tài khoản Steam</th>
                        <th width="30%">Thư mục cài đặt</th>
                        <th width="20%">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="profilesTableBody">
                    <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle me-2"></i>
            Chọn một profile từ danh sách để gán cho game này. Các profile được lấy từ danh sách tài khoản đã cấu hình trong trang Quản lý tài khoản Steam.
        </div>

        <div class="mt-3">
            <a href="/SteamAccounts" class="btn btn-primary me-2" target="_blank">
                <i class="bi bi-gear me-1"></i> Quản lý tài khoản
            </a>
            <button id="refreshProfileList" class="btn btn-info me-2">
                <i class="bi bi-arrow-clockwise me-1"></i> Làm mới danh sách
            </button>
            <button id="cancelProfileSelection" class="btn btn-secondary">
                <i class="bi bi-x-circle me-1"></i> Đóng
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Thông tin cập nhật game đã kiểm tra</h5>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>App ID</th>
                        <th>Tên game</th>
                        <th>Profile</th>
                        <th>Loại</th>
                        <th>Dung lượng</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.UpdateInfos != null && Model.UpdateInfos.Any())
                    {
                        foreach (var vm in Model.UpdateInfos)
                        {
                            <tr class="@(vm.IsMainApp ? "" : "dependent-app-row")">
                                <td>@vm.ApiInfo.AppID</td>
                                <td>@vm.ApiInfo.Name</td>
                                <td>@vm.ProfileName</td>
                                <td>
                                    @if (vm.IsMainApp)
                                    {
                                        <span class="badge bg-primary">Chính</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info">Phụ</span>
                                    }
                                </td>
                                <td>@vm.FormattedSize</td>
                                <td>
                                    @if (vm.NeedsUpdate)
                                    {
                                        <span class="status-badge running">
                                            <i class="bi bi-cloud-arrow-down"></i>
                                            Cần cập nhật
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="status-badge stopped">
                                            <i class="bi bi-check-circle"></i>
                                            Đã cập nhật
                                        </span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn-icon update-btn" data-appid="@vm.ApiInfo.AppID" data-profileid="@vm.ProfileId" data-ismain="@vm.IsMainApp.ToString().ToLower()" title="Cập nhật">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                        @if (vm.IsMainApp)
                                        {
                                            <button class="btn-icon select-profile-btn" 
                                                    data-appid="@vm.ApiInfo.AppID" 
                                                    data-profileid="@vm.ProfileId" 
                                                    data-profilename="@vm.ProfileName"
                                                    data-gamename="@vm.ApiInfo.Name"
                                                    title="Chọn Profile">
                                                <i class="bi bi-person-fill-gear"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center">Không có thông tin cập nhật nào. Hãy kiểm tra cập nhật lần đầu tiên.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .dependent-app-row {
        background-color: #f8f9fa;
    }

    .dependent-app-row td {
        padding-top: 8px;
        padding-bottom: 8px;
        font-size: 0.95em;
    }

    .badge.bg-primary {
        background-color: #3498db !important;
    }

    .badge.bg-info {
        background-color: #17a2b8 !important;
        color: white !important;
    }
    
    .profile-selection-header {
        position: sticky;
        top: 0;
        z-index: 100;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Lấy token CSRF
            var token = $('input[name="__RequestVerificationToken"]').val();
            
            // Hàm để tải danh sách profile
            function loadProfilesList(appId, profileId, callback) {
                $("#profilesTableBody").html('<tr><td colspan="5" class="text-center"><i class="bi bi-hourglass-split me-2"></i>Đang tải danh sách profile...</td></tr>');
                
                $.ajax({
                    url: "/UpdateManagement?handler=ProfilesForSelection",
                    method: "GET",
                    success: function(response) {
                        if (response.success) {
                            // Xóa dữ liệu cũ trong bảng
                            $("#profilesTableBody").empty();
                            
                            if (response.profiles.length === 0) {
                                $("#profilesTableBody").html('<tr><td colspan="5" class="text-center">Không có profile nào. Hãy tạo profile trong trang <a href="/SteamAccounts" target="_blank">Quản lý tài khoản Steam</a>.</td></tr>');
                                return;
                            }
                            
                            // Thêm dữ liệu mới
                            response.profiles.forEach(function(profile) {
                                const isActive = profile.id === profileId;
                                const row = `
                                    <tr class="${isActive ? 'table-primary' : ''}">
                                        <td>${profile.id}</td>
                                        <td>
                                            <strong>${profile.name}</strong>
                                        </td>
                                        <td>
                                            <span class="badge ${profile.hasSteamAccount ? 'bg-success' : 'bg-secondary'} me-1">
                                                <i class="bi bi-steam me-1"></i>
                                            </span>
                                            ${profile.steamAccount}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="bi bi-folder me-1"></i>
                                                ${profile.installDirectory}
                                            </small>
                                        </td>
                                        <td class="text-center">
                                            ${isActive 
                                                ? '<span class="badge bg-success">Đang sử dụng</span>' 
                                                : `<button class="btn btn-sm btn-primary select-profile-action" data-profileid="${profile.id}" data-appid="${appId}">Chọn</button>`
                                            }
                                        </td>
                                    </tr>
                                `;
                                $("#profilesTableBody").append(row);
                            });
                            
                            if (typeof callback === 'function') {
                                callback();
                            }
                        } else {
                            alert("Lỗi: " + (response.message || "Không thể lấy danh sách profiles"));
                        }
                    },
                    error: function(xhr, status, error) {
                        $("#profilesTableBody").html('<tr><td colspan="5" class="text-center text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Lỗi khi tải danh sách profile</td></tr>');
                        console.error("Lỗi khi lấy danh sách profiles: " + error);
                    }
                });
            }

            // Kiểm tra cập nhật ngay
            $("#checkUpdatesBtn").click(function() {
                $(this).prop("disabled", true).html("<i class='bi bi-hourglass-split me-1'></i> Đang kiểm tra...");

                $.ajax({
                    url: "/UpdateManagement?handler=CheckUpdates",
                    method: "POST",
                    headers: {
                        "RequestVerificationToken": token
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert("Lỗi: " + (response.message || "Không thể kiểm tra cập nhật"));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Lỗi khi kiểm tra cập nhật: " + error);
                    },
                    complete: function() {
                        $("#checkUpdatesBtn").prop("disabled", false).html("<i class='bi bi-cloud-download me-1'></i> Kiểm tra cập nhật ngay");
                    }
                });
            });

            // Xóa cache cập nhật
            $("#clearCacheBtn").click(function() {
                if (confirm("Bạn có chắc muốn xóa cache cập nhật không? Thao tác này sẽ buộc hệ thống kiểm tra lại thông tin từ Steam API ở lần kiểm tra tiếp theo.")) {
                    $(this).prop("disabled", true).html("<i class='bi bi-hourglass-split me-1'></i> Đang xóa...");

                    $.ajax({
                        url: "/UpdateManagement?handler=ClearCache",
                        method: "POST",
                        headers: {
                            "RequestVerificationToken": token
                        },
                        success: function(response) {
                            if (response.success) {
                                alert(response.message);
                                location.reload();
                            } else {
                                alert("Lỗi: " + (response.message || "Không thể xóa cache cập nhật"));
                            }
                        },
                        error: function(xhr, status, error) {
                            alert("Lỗi khi xóa cache cập nhật: " + error);
                        },
                        complete: function() {
                            $("#clearCacheBtn").prop("disabled", false).html("<i class='bi bi-trash me-1'></i> Xóa cache cập nhật");
                        }
                    });
                }
            });

            // Biến lưu trữ dữ liệu cho phiên chọn profile hiện tại
            let currentSelection = {
                appId: null,
                profileId: null,
                profileName: null,
                gameName: null
            };

            // Chọn profile cho game (mới với expand thay vì modal)
            $(document).on("click", ".select-profile-btn", function() {
                const appId = $(this).data("appid");
                const profileId = $(this).data("profileid");
                const profileName = $(this).data("profilename");
                const gameName = $(this).data("gamename");
                
                // Lưu thông tin vào biến phiên hiện tại
                currentSelection = {
                    appId: appId,
                    profileId: profileId,
                    profileName: profileName,
                    gameName: gameName
                };
                
                // Hiển thị thông tin hiện tại
                $("#selectedGameName").text(gameName);
                $("#currentAppId").text(appId);
                $("#currentProfileName").text(profileName);
                
                // Tải danh sách profiles
                loadProfilesList(appId, profileId, function() {
                    // Hiển thị vùng chọn profile và cuộn trang đến đó
                    $("#profileSelectionContainer").show();
                    $('html, body').animate({
                        scrollTop: $("#profileSelectionContainer").offset().top - 20
                    }, 500);
                });
            });
            
            // Làm mới danh sách profile
            $("#refreshProfileList").click(function() {
                if (currentSelection.appId) {
                    loadProfilesList(currentSelection.appId, currentSelection.profileId);
                }
            });
            
            // Đóng phần chọn profile
            $("#cancelProfileSelection").click(function() {
                $("#profileSelectionContainer").hide();
            });
            
            // Xử lý khi chọn profile
            $(document).on("click", ".select-profile-action", function() {
                const profileId = $(this).data("profileid");
                const appId = $(this).data("appid");
                
                $(this).prop("disabled", true).html("<i class='bi bi-hourglass-split'></i>");
                
                $.ajax({
                    url: "/UpdateManagement?handler=ChangeGameProfile",
                    method: "POST",
                    data: { appId: appId, profileId: profileId },
                    headers: {
                        "RequestVerificationToken": token
                    },
                    success: function(response) {
                        if (response.success) {
                            // Ẩn vùng chọn profile và reload trang
                            $("#profileSelectionContainer").hide();
                            alert("Đã thay đổi profile thành công!");
                            location.reload();
                        } else {
                            alert("Lỗi: " + (response.message || "Không thể thay đổi profile"));
                            $(this).prop("disabled", false).html("Chọn");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Lỗi khi thay đổi profile: " + error);
                        $(this).prop("disabled", false).html("Chọn");
                    }
                });
            });

            // Xử lý nút cập nhật (update-btn)
            $(".update-btn").click(function() {
                var appId = $(this).data("appid");
                var profileId = $(this).data("profileid");
                var isMain = $(this).data("ismain");
                var button = $(this);

                button.prop("disabled", true);
                button.html("<i class='bi bi-hourglass-split'></i>");

                $.ajax({
                    url: "/UpdateManagement?handler=UpdateApp",
                    method: "POST",
                    data: {
                        appId: appId,
                        profileId: profileId,
                        isMainApp: isMain
                    },
                    headers: {
                        "RequestVerificationToken": token
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                        } else {
                            alert("Lỗi: " + (response.message || "Không thể cập nhật game"));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Lỗi khi gửi yêu cầu cập nhật: " + error);
                    },
                    complete: function() {
                        button.prop("disabled", false);
                        button.html("<i class='bi bi-arrow-repeat'></i>");
                    }
                });
            });
        });
    </script>
}
```